OrderFlowsTestCase.test_flows_order_cancel_with_course_implied_in_several_products:
- db: 'SELECT # AS "a" FROM "joanie_organization" WHERE "joanie_organization"."id" = #::uuid LIMIT #'
- db: 'SELECT # AS "a" FROM "joanie_product" WHERE "joanie_product"."id" = #::uuid LIMIT #'
- db: 'SELECT # AS "a" FROM "joanie_course" WHERE "joanie_course"."id" = #::uuid LIMIT #'
- db: 'SELECT # AS "a" FROM "joanie_user" WHERE "joanie_user"."id" = #::uuid LIMIT #'
- db: 'SELECT # AS "_check" WHERE COALESCE((NOT (# IN (...)) AND EXISTS(SELECT # AS "a" FROM "joanie_order" U0 WHERE (U0."course_id" = #::uuid AND U0."owner_id" = #::uuid AND U0."product_id" = #::uuid AND NOT (U0."id" = #::uuid) AND NOT (U0."state" IN (...))) LIMIT #)), true)'
- db: 'SELECT # AS "_check" WHERE COALESCE(...)'
- db: 'SELECT # AS "_check" WHERE COALESCE(...)'
- db: 'UPDATE "joanie_order" SET ... WHERE "joanie_order"."id" = #::uuid'
- db: 'SELECT ... FROM "joanie_enrollment" INNER JOIN "joanie_course_run" ON ("joanie_enrollment"."course_run_id" = "joanie_course_run"."id") INNER JOIN "joanie_user" ON ("joanie_enrollment"."user_id" = "joanie_user"."id") WHERE ("joanie_enrollment"."course_run_id" IN (SELECT DISTINCT X0."id" FROM "joanie_course_run" X0 LEFT OUTER JOIN "joanie_order_target_course_relation_course_runs" X1 ON (X0."id" = X1."courserun_id") WHERE (X1."ordertargetcourserelation_id" IN (SELECT U0."id" FROM "joanie_order_target_course_relation" U0 INNER JOIN "joanie_order_target_course_relation_course_runs" U2 ON (U0."id" = U2."ordertargetcourserelation_id") WHERE (U0."order_id" = #::uuid AND U2."courserun_id" IS NOT NULL)) OR X0."course_id" IN (SELECT W0."id" FROM "joanie_course" W0 INNER JOIN "joanie_order_target_course_relation" W1 ON (W0."id" = W1."course_id") WHERE (W1."order_id" = #::uuid AND NOT (EXISTS(SELECT # AS "a" FROM "joanie_order_target_course_relation" V1 WHERE (V1."id" IN (SELECT U0."id" FROM "joanie_order_target_course_relation" U0 INNER JOIN "joanie_order_target_course_relation_course_runs" U2 ON (U0."id" = U2."ordertargetcourserelation_id") WHERE (U0."order_id" = #::uuid AND U2."courserun_id" IS NOT NULL)) AND V1."id" = (W1."id") AND W1."course_id" = (W0."id")) LIMIT #)))))) AND "joanie_enrollment"."is_active" AND "joanie_enrollment"."user_id" = #::uuid) ORDER BY "joanie_enrollment"."created_on" DESC'
- cache|set: dummy_lms_backend_enrollment_user#_http://openedx.test/courses/course-v#:edx+#+#/course/
- db: 'UPDATE "joanie_enrollment" SET ... WHERE "joanie_enrollment"."id" = #::uuid'
- db: 'SELECT ... FROM "joanie_enrollment" INNER JOIN "joanie_course_run" ON ("joanie_enrollment"."course_run_id" = "joanie_course_run"."id") WHERE ("joanie_enrollment"."course_run_id" IN (SELECT DISTINCT X0."id" FROM "joanie_course_run" X0 LEFT OUTER JOIN "joanie_order_target_course_relation_course_runs" X1 ON (X0."id" = X1."courserun_id") WHERE (X1."ordertargetcourserelation_id" IN (SELECT U0."id" FROM "joanie_order_target_course_relation" U0 INNER JOIN "joanie_order_target_course_relation_course_runs" U2 ON (U0."id" = U2."ordertargetcourserelation_id") WHERE (U0."order_id" = #::uuid AND U2."courserun_id" IS NOT NULL)) OR X0."course_id" IN (SELECT W0."id" FROM "joanie_course" W0 INNER JOIN "joanie_order_target_course_relation" W1 ON (W0."id" = W1."course_id") WHERE (W1."order_id" = #::uuid AND NOT (EXISTS(SELECT # AS "a" FROM "joanie_order_target_course_relation" V1 WHERE (V1."id" IN (SELECT U0."id" FROM "joanie_order_target_course_relation" U0 INNER JOIN "joanie_order_target_course_relation_course_runs" U2 ON (U0."id" = U2."ordertargetcourserelation_id") WHERE (U0."order_id" = #::uuid AND U2."courserun_id" IS NOT NULL)) AND V1."id" = (W1."id") AND W1."course_id" = (W0."id")) LIMIT #)))))) AND "joanie_enrollment"."is_active" AND "joanie_enrollment"."user_id" = #::uuid) ORDER BY "joanie_enrollment"."created_on" DESC'
- db: 'SELECT ... FROM "joanie_course" WHERE "joanie_course"."id" = #::uuid LIMIT #'
- db: 'SELECT # AS "a" FROM "joanie_product" INNER JOIN "joanie_product_target_course_relation" ON ("joanie_product"."id" = "joanie_product_target_course_relation"."product_id") INNER JOIN "joanie_order" ON ("joanie_product"."id" = "joanie_order"."product_id") WHERE ("joanie_product_target_course_relation"."course_id" = #::uuid AND "joanie_order"."id" IN (SELECT U0."id" FROM "joanie_order" U0 WHERE (U0."owner_id" = #::uuid AND NOT (U0."state" = #))) AND NOT ("joanie_product"."id" = #::uuid)) LIMIT #'
- db: 'SELECT # AS "a" FROM "joanie_offeringrule" INNER JOIN "joanie_order_offering_rules" ON ("joanie_offeringrule"."id" = "joanie_order_offering_rules"."offeringrule_id") WHERE "joanie_order_offering_rules"."order_id" = #::uuid LIMIT #'
OrderFlowsTestCase.test_flows_order_cancel_with_listed_course_run:
- db: 'SELECT # AS "a" FROM "joanie_organization" WHERE "joanie_organization"."id" = #::uuid LIMIT #'
- db: 'SELECT # AS "a" FROM "joanie_product" WHERE "joanie_product"."id" = #::uuid LIMIT #'
- db: 'SELECT # AS "a" FROM "joanie_course" WHERE "joanie_course"."id" = #::uuid LIMIT #'
- db: 'SELECT # AS "a" FROM "joanie_user" WHERE "joanie_user"."id" = #::uuid LIMIT #'
- db: 'SELECT # AS "_check" WHERE COALESCE((NOT (# IN (...)) AND EXISTS(SELECT # AS "a" FROM "joanie_order" U0 WHERE (U0."course_id" = #::uuid AND U0."owner_id" = #::uuid AND U0."product_id" = #::uuid AND NOT (U0."id" = #::uuid) AND NOT (U0."state" IN (...))) LIMIT #)), true)'
- db: 'SELECT # AS "_check" WHERE COALESCE(...)'
- db: 'SELECT # AS "_check" WHERE COALESCE(...)'
- db: 'UPDATE "joanie_order" SET ... WHERE "joanie_order"."id" = #::uuid'
- db: 'SELECT ... FROM "joanie_enrollment" INNER JOIN "joanie_course_run" ON ("joanie_enrollment"."course_run_id" = "joanie_course_run"."id") INNER JOIN "joanie_user" ON ("joanie_enrollment"."user_id" = "joanie_user"."id") WHERE ("joanie_enrollment"."course_run_id" IN (SELECT DISTINCT X0."id" FROM "joanie_course_run" X0 LEFT OUTER JOIN "joanie_order_target_course_relation_course_runs" X1 ON (X0."id" = X1."courserun_id") WHERE (X1."ordertargetcourserelation_id" IN (SELECT U0."id" FROM "joanie_order_target_course_relation" U0 INNER JOIN "joanie_order_target_course_relation_course_runs" U2 ON (U0."id" = U2."ordertargetcourserelation_id") WHERE (U0."order_id" = #::uuid AND U2."courserun_id" IS NOT NULL)) OR X0."course_id" IN (SELECT W0."id" FROM "joanie_course" W0 INNER JOIN "joanie_order_target_course_relation" W1 ON (W0."id" = W1."course_id") WHERE (W1."order_id" = #::uuid AND NOT (EXISTS(SELECT # AS "a" FROM "joanie_order_target_course_relation" V1 WHERE (V1."id" IN (SELECT U0."id" FROM "joanie_order_target_course_relation" U0 INNER JOIN "joanie_order_target_course_relation_course_runs" U2 ON (U0."id" = U2."ordertargetcourserelation_id") WHERE (U0."order_id" = #::uuid AND U2."courserun_id" IS NOT NULL)) AND V1."id" = (W1."id") AND W1."course_id" = (W0."id")) LIMIT #)))))) AND "joanie_enrollment"."is_active" AND "joanie_enrollment"."user_id" = #::uuid) ORDER BY "joanie_enrollment"."created_on" DESC'
- db: 'SELECT ... FROM "joanie_enrollment" INNER JOIN "joanie_course_run" ON ("joanie_enrollment"."course_run_id" = "joanie_course_run"."id") WHERE ("joanie_enrollment"."course_run_id" IN (SELECT DISTINCT X0."id" FROM "joanie_course_run" X0 LEFT OUTER JOIN "joanie_order_target_course_relation_course_runs" X1 ON (X0."id" = X1."courserun_id") WHERE (X1."ordertargetcourserelation_id" IN (SELECT U0."id" FROM "joanie_order_target_course_relation" U0 INNER JOIN "joanie_order_target_course_relation_course_runs" U2 ON (U0."id" = U2."ordertargetcourserelation_id") WHERE (U0."order_id" = #::uuid AND U2."courserun_id" IS NOT NULL)) OR X0."course_id" IN (SELECT W0."id" FROM "joanie_course" W0 INNER JOIN "joanie_order_target_course_relation" W1 ON (W0."id" = W1."course_id") WHERE (W1."order_id" = #::uuid AND NOT (EXISTS(SELECT # AS "a" FROM "joanie_order_target_course_relation" V1 WHERE (V1."id" IN (SELECT U0."id" FROM "joanie_order_target_course_relation" U0 INNER JOIN "joanie_order_target_course_relation_course_runs" U2 ON (U0."id" = U2."ordertargetcourserelation_id") WHERE (U0."order_id" = #::uuid AND U2."courserun_id" IS NOT NULL)) AND V1."id" = (W1."id") AND W1."course_id" = (W0."id")) LIMIT #)))))) AND "joanie_enrollment"."is_active" AND "joanie_enrollment"."user_id" = #::uuid) ORDER BY "joanie_enrollment"."created_on" DESC'
- db: 'SELECT # AS "a" FROM "joanie_offeringrule" INNER JOIN "joanie_order_offering_rules" ON ("joanie_offeringrule"."id" = "joanie_order_offering_rules"."offeringrule_id") WHERE "joanie_order_offering_rules"."order_id" = #::uuid LIMIT #'
